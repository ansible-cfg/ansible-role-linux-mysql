---
- name: Check if MySQL tablespace exists
  stat:
    path: '{{ item }}'
  with_items:
    - '{{ mysql_path }}/mysql/mysql/db.MYD'
  register: result

- name: MySQL operation
  block:
    - name: Include OS-specific variables
      include_vars: '{{ ansible_os_family }}.yml'
    - name: Include tasks for specific OS
      include: '{{ ansible_os_family }}.yml'
    - name: Straight to getenforce selinux status
      include: 'selinux.yml' 
    - name: Include firewall tasks
      include: 'firewall.yml'
    - name: Include initialization tasks
      include: 'initialization.yml'
    - name: Include user grants tasks
      include: 'user.yml'
    - name: Include business database tasks
      include: 'database.yml'
      when:
        - mysql_bu_dbs_arg is defined
    - name: Include query analyzes tasks
      include: 'analyzes.yml'
    - name: Include backup tasks
      include: 'backup.yml'
    - name: Include prometheus exporter tasks
      include: 'exporter.yml'
    - include_tasks: 'register.yml'
      when: consul_public_register
    - name: Ensure MTA service is enabled
      systemd:
        name: 'postfix.service'
        enabled: 'yes'
        state: 'started'
      when:
        - ansible_distribution_major_version|int > 6
    - name: Ensure MTA service is enabled
      service:
        name: 'postfix'
        enabled: 'yes'
        state: 'started'
      when:
        - ansible_distribution_major_version|int < 7
  when:
    - not result.results[0].stat.exists
