---
- name: Include OS-specific variables
  include_vars: '{{ ansible_os_family }}.yml'

- name: Include tasks for specific OS
  include: '{{ ansible_os_family }}.yml'

- name: Include firewall tasks
  include: 'firewall.yml'

- name: Check if MySQL tablespace exists
  stat:
    path: '{{ item }}'
  with_items:
    - '{{ mysql_path }}/mysql/mysql/db.MYD'
  register: result

- name: Include initialization tasks
  include: 'initialization.yml'
  when:
    - not result.results[0].stat.exists

- name: Include user grants tasks
  include: 'user.yml'
  when:
    - not result.results[0].stat.exists

- name: Include query analyzes tasks
  include: 'analyzes.yml'
  when:
    - not result.results[0].stat.exists

- name: Include backup tasks
  include: 'backup.yml'
  when:
    - not result.results[0].stat.exists

- name: Include prometheus exporter tasks
  include: 'mysqld_exporter.yml'

- name: Ensure MTA service is enabled
  systemd:
    name: 'postfix.service'
    enabled: 'yes'
    state: 'started'
  when:
    - ansible_distribution_major_version|int > 6
