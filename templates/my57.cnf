[mysql]
# CLIENT #
[client]
port                                   = {{ mysql_port_mysqld }}
socket                                 = {{ mysql_path }}/mysql/mysql.sock

[mysqld_safe]
# GENERAL #
malloc-lib                             = /usr/lib64/libjemalloc.so.1
thp-setting                            = never

[mysqld]
# PERFORMANCE #
#performance-schema-instrument          = 'memory/%=ON' # https://jira.percona.com/browse/PS-3734
performance_schema                     = 0
userstat                               = 1
thread_statistics                      = 1
query_response_time_stats              = 1

# GENERAL #
server_id                              = {{ (2 ** 32 - 1) | random }}
user                                   = {{ mysql_user }}
default_storage_engine                 = {{ mysql_storage_engine }}
character_set_server                   = {{ mysql_arg.character_set }}
socket                                 = {{ mysql_path }}/mysql/mysql.sock
explicit_defaults_for_timestamp        = 1
log_timestamps                         = SYSTEM
bind-address                           = 0.0.0.0
port                                   = {{ mysql_port_mysqld }}
ignore-db-dir                          = binlog
ignore-db-dir                          = logs
ignore-db-dir                          = innodb
ignore-db-dir                          = mysqlsla_analyzes
sql_mode                               = {{ ','.join(vars['mysql_sql_mode']) }}

# MyISAM #
key_buffer_size                        = {{ mysql_arg.key_buffer_size }}M
myisam-recover-options                 = FORCE,BACKUP

# SAFETY #
#memlock
#large_pages                            = 1
skip_ssl
core-file
skip-name-resolve
local-infile                           = 0
default_password_lifetime              = 0
log-raw                                = OFF
max_prepared_stmt_count                = {{ mysql_arg.max_prepared_stmt_count }}
max_allowed_packet                     = {{ mysql_arg.max_allowed_packet }}
max_connect_errors                     = {{ mysql_arg.max_connect_errors }}

# DATA STORAGE #
datadir                                = {{ mysql_path }}/mysql

# BINARY LOGGING #
log_bin                                = {{ mysql_path }}/mysql/binlog/mysql_bin
binlog_cache_size                      = {{ mysql_arg.binlog_cache_size }}
binlog_stmt_cache_size                 = {{ mysql_arg.binlog_stmt_cache_size }}
binlog_format                          = {{ mysql_arg.binlog_format }}
expire_logs_days                       = {{ mysql_arg.expire_logs_days }}
sync_binlog                            = {{ mysql_arg.sync_binlog }}

# CACHES AND LIMITS #
connect_timeout                        = {{ mysql_arg.connect_timeout }}
wait_timeout                           = {{ mysql_arg.wait_timeout }}
interactive_timeout                    = {{ mysql_arg.interactive_timeout }}
tmp_table_size                         = {{ mysql_arg.tmp_table_size }}
max_heap_table_size                    = {{ mysql_arg.max_heap_table_size }}
join_buffer_size                       = {{ mysql_arg.join_buffer_size }}
read_rnd_buffer_size                   = {{ mysql_arg.read_rnd_buffer_size }}
query_cache_type                       = {{ mysql_arg.query_cache_type }}
query_cache_size                       = {{ mysql_arg.query_cache_size }}
max_connections                        = {{ mysql_max_connections }}
thread_cache_size                      = {{ mysql_arg.thread_cache_size }}
thread_handling                        = {{ mysql_arg.thread_handling }}
thread_pool_max_threads                = {{ mysql_arg.thread_pool_max_threads }}
thread_pool_oversubscribe              = {{ mysql_arg.thread_pool_oversubscribe }}
open_files_limit                       = {{ mysql_arg.open_files_limit }}
performance_schema_max_table_instances = {{ mysql_arg.performance_schema_max_table_instances }}
table_definition_cache                 = {{ mysql_arg.table_definition_cache }}
table_open_cache                       = {{ mysql_arg.table_open_cache }}
table_open_cache_instances             = {{ mysql_arg.table_open_cache_instances }}

# INNODB #
innodb_autoinc_lock_mode               = 2
innodb_buffer_pool_dump_at_shutdown    = 1
innodb_buffer_pool_dump_now            = 1
innodb_buffer_pool_dump_pct            = 100
innodb_buffer_pool_instances           = {{ mysql_arg.innodb_buffer_pool_instances }}
innodb_buffer_pool_load_at_startup     = 1
innodb_buffer_pool_load_now 	       = 1
innodb_buffer_pool_size                = {{ mysql_innodb_buffer_pool_size }}M
innodb_data_file_path                  = ibdata1:256M;ibdata2:256M:autoextend
innodb_data_home_dir                   = {{ mysql_path }}/mysql/innodb
innodb_doublewrite                     = 1
innodb_file_per_table                  = 1
innodb_flush_log_at_trx_commit         = {{ mysql_arg.innodb_flush_log_at_trx_commit }}
innodb_flush_method                    = O_DIRECT
innodb_io_capacity                     = 1000
innodb_log_buffer_size                 = {{ mysql_arg.innodb_log_buffer_size }}M
innodb_log_file_size                   = {{ mysql_arg.innodb_log_file_size }}M
innodb_log_files_in_group              = 2
innodb_log_group_home_dir              = {{ mysql_path }}/mysql/innodb
innodb_max_dirty_pages_pct             = {{ mysql_arg.innodb_max_dirty_pages_pct }}
innodb_max_undo_log_size               = {{ mysql_arg.innodb_max_undo_log_size }}M
innodb_page_cleaners                   = {{ mysql_arg.innodb_page_cleaners }}
innodb_purge_threads                   = {{ mysql_arg.innodb_purge_threads }}
innodb_read_io_threads                 = {{ mysql_arg.innodb_read_io_threads }}
innodb_temp_data_file_path             = ibtemp1:128M;ibtemp2:128M:autoextend:max:1024M
innodb_undo_directory                  = {{ mysql_path }}/mysql/innodb/undolog
innodb_undo_log_truncate               = 1
innodb_undo_tablespaces                = 64
innodb_write_io_threads                = {{ mysql_arg.innodb_write_io_threads }}

# LOGGING #
log_error                              = {{ mysql_path }}/mysql/logs/mysql_error.log
slow_query_log                         = 1
slow_query_log_file                    = {{ mysql_path }}/mysql/logs/mysql_slow.log
log_queries_not_using_indexes          = {{ mysql_arg.log_queries_not_using_indexes }}
long_query_time                        = {{ mysql_arg.long_query_time }}
log_syslog                             = ON
audit_log_handler                      = SYSLOG
audit_log_format                       = CSV
audit_log_policy                       = QUERIES
audit_log_syslog_ident                 = mysqld
audit_log_include_commands             = "{{ ','.join(vars['mysql_audit_log_commands']) }}"

# PLUGIN #
plugin-load                            = "audit_log=audit_log.so;QUERY_RESPONSE_TIME=query_response_time.so;QUERY_RESPONSE_TIME_AUDIT=query_response_time.so;QUERY_RESPONSE_TIME_READ=query_response_time.so;QUERY_RESPONSE_TIME_WRITE=query_response_time.so"
